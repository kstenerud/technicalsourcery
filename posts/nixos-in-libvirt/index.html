<!doctype html><html lang=en>
<head>
<meta charset=utf-8>
<meta name=viewport content="width=device-width,initial-scale=1">
<title>Test-driving a NixOS VM using libvirt - ðŸª„ Technical Sourcery</title><link rel=apple-touch-icon href=https://kstenerud.github.io/technicalsourcery/images/icons/icon-180x180.png sizes=180x180>
<link rel=icon href=https://kstenerud.github.io/technicalsourcery/images/icons/icon-32x32.png sizes=32x32 type=image/png>
<link rel=icon href=https://kstenerud.github.io/technicalsourcery/images/icons/icon-16x16.png sizes=16x16 type=image/png>
<link rel=icon href=https://kstenerud.github.io/technicalsourcery/images/icons/favicon.ico>
<link rel=manifest href=https://kstenerud.github.io/technicalsourcery/manifest.json>
<meta name=keywords content>
<meta name=description content="NixOS has a lot of really cool ideas, but unfortunately installing on a VM is still tricky. This guide is designed as a &#34;just get me something working, please!&#34; way to get a headless NixOS install up and running in a libvirt VM."><meta itemprop=name content="Test-driving a NixOS VM using libvirt">
<meta itemprop=description content="NixOS has a lot of really cool ideas, but unfortunately installing on a VM is still tricky. This guide is designed as a &#34;just get me something working, please!&#34; way to get a headless NixOS install up and running in a libvirt VM."><meta itemprop=datePublished content="2021-08-01T14:11:43+01:00">
<meta itemprop=dateModified content="2021-08-01T14:11:43+01:00">
<meta itemprop=wordCount content="1148"><meta itemprop=image content="https://kstenerud.github.io/technicalsourcery/images/thumbnails/nixos.png">
<meta itemprop=keywords content="virtualization,nixos,libvirt,headless,"><meta property="og:title" content="Test-driving a NixOS VM using libvirt">
<meta property="og:description" content="NixOS has a lot of really cool ideas, but unfortunately installing on a VM is still tricky. This guide is designed as a &#34;just get me something working, please!&#34; way to get a headless NixOS install up and running in a libvirt VM.">
<meta property="og:type" content="article">
<meta property="og:url" content="https://kstenerud.github.io/technicalsourcery/posts/nixos-in-libvirt/"><meta property="og:image" content="https://kstenerud.github.io/technicalsourcery/images/thumbnails/nixos.png"><meta property="article:section" content="posts">
<meta property="article:published_time" content="2021-08-01T14:11:43+01:00">
<meta property="article:modified_time" content="2021-08-01T14:11:43+01:00">
<meta name=twitter:card content="summary_large_image">
<meta name=twitter:image content="https://kstenerud.github.io/technicalsourcery/images/thumbnails/nixos.png">
<meta name=twitter:title content="Test-driving a NixOS VM using libvirt">
<meta name=twitter:description content="NixOS has a lot of really cool ideas, but unfortunately installing on a VM is still tricky. This guide is designed as a &#34;just get me something working, please!&#34; way to get a headless NixOS install up and running in a libvirt VM.">
<meta name=robots content="index, follow"><link rel=stylesheet href=https://kstenerud.github.io/technicalsourcery/css/bundle.min.adafd81624e28648439656f4aeba9adda4e7586da003efb5780ca8cec9292a9a.css integrity="sha256-ra/YFiTihkhDllb0rrqa3aTnWG2gA++1eAyozskpKpo=" crossorigin=anonymous>
<noscript><link rel=stylesheet href=https://kstenerud.github.io/technicalsourcery/css/bundle.min.adafd81624e28648439656f4aeba9adda4e7586da003efb5780ca8cec9292a9a.css integrity="sha256-ra/YFiTihkhDllb0rrqa3aTnWG2gA++1eAyozskpKpo=" crossorigin=anonymous></noscript></head>
<body><script>const items=['mode','palette'];items.forEach(function(a){const b=localStorage.getItem('hbs-'+a);b&&document.body.parentElement.setAttribute('data-'+a,b)})</script><header><nav class="navbar top-app-bar top-app-bar-expand-lg fixed-top">
<div class=container>
<button class=navbar-toggler type=button data-bs-toggle=collapse data-bs-target=#navbarSupportedContent aria-controls=navbarSupportedContent aria-expanded=false aria-label="Toggle navigation">
<i class="fas fa-bars"></i>
</button><a class="navbar-brand me-3" href=https://kstenerud.github.io/technicalsourcery/>ðŸª„ Technical Sourcery
</a>
<button class=navbar-social-share type=button data-bs-toggle=offcanvas data-bs-target=#offcanvasSocialShare aria-controls=offcanvasSocialShare aria-label="Toggle social share">
<i class="fas fa-share-alt"></i>
</button>
<div class="offcanvas offcanvas-bottom surface" tabindex=-1 id=offcanvasSocialShare aria-labelledby=offcanvasSocialShare>
<div class=offcanvas-header>
<h3 class=offcanvas-title>Share</h3>
<button type=button class="btn btn-sm btn-outline-primary" data-bs-dismiss=offcanvas aria-label=Close>
<i class="fas fa-times"></i>
</button>
</div>
<div class=offcanvas-body>
<a class="btn btn-sm btn-outline-primary social-share-button" rel="noopener noreferrer" aria-label="Twitter Share Button" target=_blank href="https://twitter.com/intent/tweet?title=Test-driving%20a%20NixOS%20VM%20using%20libvirt&url=https%3a%2f%2fkstenerud.github.io%2ftechnicalsourcery%2fposts%2fnixos-in-libvirt%2f">
<i class="fab fa-fw fa-twitter"></i> Twitter
</a>
<a class="btn btn-sm btn-outline-primary social-share-button" rel="noopener noreferrer" aria-label="Facebook Share Button" target=_blank href="https://www.facebook.com/sharer/sharer.php?u=https%3a%2f%2fkstenerud.github.io%2ftechnicalsourcery%2fposts%2fnixos-in-libvirt%2f">
<i class="fab fa-fw fa-facebook-f"></i> Facebook
</a>
</div>
</div>
<button class=navbar-settings type=button data-bs-toggle=offcanvas data-bs-target=#offcanvasSettings aria-controls=offcanvasSettings aria-label="Toggle settings">
<i class="fas fa-ellipsis-v"></i>
</button>
<div class="offcanvas offcanvas-end surface h-100" tabindex=-1 id=offcanvasSettings aria-labelledby=offcanvasSettings>
<div class=offcanvas-header>
<h3 class=offcanvas-title>Settings</h3>
<button type=button class="btn btn-sm btn-outline-primary" data-bs-dismiss=offcanvas aria-label=Close>
<i class="fas fa-times"></i>
</button>
</div>
<div class="offcanvas-body d-flex flex-column"><section class=setting>
<form class=row>
<div class=col-auto>
<label for=fontSize class=form-label><i class="fas fa-fw fa-language"></i> Language</label>
</div>
<div class="col-auto ms-auto">
<div class=dropdown>
<a class="btn btn-sm btn-outline-primary dropdown-toggle" href=# id=languageDropdown role=button data-bs-toggle=dropdown aria-expanded=false>
English
</a>
<ul class="dropdown-menu dropdown-menu-end" aria-labelledby=languageDropdown><li><a class=dropdown-item href=https://kstenerud.github.io/technicalsourcery/fr/></a></li></ul>
</div>
</div>
</form>
</section>
<section class=setting>
<form class=row>
<div class=col-auto>
<label><i class="fas fa-fw fa-adjust"></i> Mode</label>
</div>
<div class="col-auto ms-auto">
<div class="form-check form-switch">
<input class=form-check-input type=checkbox id=modeSwitcher>
</div>
</div>
</form>
</section>
<section class=setting>
<form class="font-size-switcher-form row">
<div class=col-auto>
<label for=fontSize class=form-label><i class="fas fa-fw fa-font"></i> Font Size</label>
</div>
<div class="col-auto ms-auto">
<input type=range class=form-range min=-2 max=2 id=fontSize>
</div>
</form>
</section>
<section class="setting palettes">
<form class=row>
<div class=col-auto>
<label><i class="fas fa-fw fa-palette"></i> Palette</label>
</div>
<div class="col-auto ms-auto">
<a id=btnPalette class="btn btn-sm btn-outline-primary" role=button aria-label=palettePicker>
<i class="fas fa-eye-dropper"></i>
</a>
</div>
</form>
<div class="mt-2 d-flex visually-hidden" id=palettePicker><button type=button id=palette-blue aria-label=Blue class="btn btn-sm palette" data-palette=blue>
</button><button type=button id=palette-blue-gray aria-label="Blue Gray" class="btn btn-sm palette" data-palette=blue-gray>
</button><button type=button id=palette-brown aria-label=Brown class="btn btn-sm palette" data-palette=brown>
</button><button type=button id=palette-cyan aria-label=Cyan class="btn btn-sm palette" data-palette=cyan>
</button><button type=button id=palette-green aria-label=Green class="btn btn-sm palette" data-palette=green>
</button><button type=button id=palette-indigo aria-label=Indigo class="btn btn-sm palette" data-palette=indigo>
</button><button type=button id=palette-orange aria-label=Orange class="btn btn-sm palette" data-palette=orange>
</button><button type=button id=palette-pink aria-label=Pink class="btn btn-sm palette" data-palette=pink>
</button><button type=button id=palette-purple aria-label=Purple class="btn btn-sm palette" data-palette=purple>
</button><button type=button id=palette-red aria-label=Red class="btn btn-sm palette" data-palette=red>
</button><button type=button id=palette-teal aria-label=Teal class="btn btn-sm palette" data-palette=teal>
</button><button type=button id=palette-yellow aria-label=Yellow class="btn btn-sm palette" data-palette=yellow>
</button></div>
</section>
<section class="setting actions d-flex justify-content-center mt-auto">
<a role=button class="d-flex flex-column align-items-center" id=pageReloader>
<i class="fas fa-2x fa-redo-alt"></i> Reload
</a>
</section>
</div>
</div>
<div class="collapse navbar-collapse" tabindex=-1 id=navbarSupportedContent aria-labelledby=navbarSupportedContent>
<form class="search-bar my-1" action=https://kstenerud.github.io/technicalsourcery/search>
<div class="input-group input-group-sm">
<span class="btn btn-search disabled position-absolute left-0"><i class="fas fa-fw fa-search"></i></span>
<input class="form-control rounded-pill" name=q type=search aria-label=Search>
</div>
</form>
<ul class="navbar-nav ms-auto"><li class=nav-item>
<a class=nav-link href=https://kstenerud.github.io/technicalsourcery/archives/>
<i class="fas fa-fw fa-file-archive"></i>Archives
</a>
</li><li class=nav-item>
<a class=nav-link href=https://kstenerud.github.io/technicalsourcery/categories/>
<i class="fas fa-fw fa-folder"></i>Categories
</a>
</li><li class=nav-item>
<a class=nav-link href=https://kstenerud.github.io/technicalsourcery/tags/>
<i class="fas fa-fw fa-tags"></i>Tags
</a>
</li><li class=nav-item>
<a class=nav-link href=https://kstenerud.github.io/technicalsourcery/series/>
<i class="fas fa-fw fa-columns"></i>Series
</a>
</li><li class="nav-item dropdown">
<a class=nav-link id=navbarDropdownLinks role=button data-bs-toggle=dropdown aria-expanded=false>
<i class="fas fa-fw fa-chevron-circle-down"></i>Quick Links
</a>
<ul class=dropdown-menu aria-labelledby=navbarDropdownLinks><li>
<a class=dropdown-item href=https://concise-encoding.org target=_blank rel="noopener noreferrer">
Concise Encoding
</a>
</li><li>
<a class=dropdown-item href=https://github.com/kstenerud target=_blank rel="noopener noreferrer">
Github
</a>
</li></ul>
</li></ul>
</div>
</div>
</nav>
</header>
<main role=main class=container>
<div class="row content">
<div class=col-lg-8>
<div class=container><nav class="row card component" aria-label=breadcrumb>
<div class=card-body>
<ol class=breadcrumb><li class=breadcrumb-item><a href=https://kstenerud.github.io/technicalsourcery/>Home</a></li><li class=breadcrumb-item><a href=https://kstenerud.github.io/technicalsourcery/posts/>Posts</a></li><li class="breadcrumb-item active">Test-Driving a NixOS VM Using Libvirt</li></ol>
</div>
</nav><article class="row card component mb-4 post"><div class=post-panel-wrapper>
<div class="d-flex flex-column component rounded post-panel">
<a id=sidebarToggler class="action d-none d-lg-block" role=button>
<i class="fas fa-fw fa-expand-alt" data-fa-transform=rotate-45></i>
</a>
<a class=action data-bs-container=body data-bs-toggle=popover data-bs-html=true data-bs-placement=bottom data-bs-trigger=focus tabindex=0 role=button aria-label=Copyright data-bs-content='<a target="_blank" rel="license noopener noreferrer" href="https://creativecommons.org/licenses/by-nc-nd/4.0/deed.en">CC BY-NC-ND 4.0 <i class="fab fa-fw fa-creative-commons"></i><i class="fab fa-fw fa-creative-commons-by"></i><i class="fab fa-fw fa-creative-commons-nc"></i><i class="fab fa-fw fa-creative-commons-nd"></i></a>
'>
<i class="fas fa-fw fa-copyright"></i>
</a>
<a class=action data-bs-toggle=offcanvas href=#offcanvasTOC aria-controls=offcanvasTOC role=button>
<i class="fas fa-fw fa-list-alt"></i>
</a>
</div>
</div>
<div class=card-body>
<h1 class="card-title post-title">Test-Driving a NixOS VM Using Libvirt
</h1><div class=post-meta>
<span class=post-date title="created on 2021-08-01 13:11:43 +0000 UTC.">
Aug 1, 2021
</span><span class=post-reading-time>
6 min read
</span><span class=post-taxonomies><a href=https://kstenerud.github.io/technicalsourcery/categories/virtualization/ class="badge rounded-pill post-taxonomy">virtualization</a><a href=https://kstenerud.github.io/technicalsourcery/tags/virtualization/ class="badge rounded-pill post-taxonomy">virtualization</a><a href=https://kstenerud.github.io/technicalsourcery/tags/nixos/ class="badge rounded-pill post-taxonomy">nixos</a><a href=https://kstenerud.github.io/technicalsourcery/tags/libvirt/ class="badge rounded-pill post-taxonomy">libvirt</a><a href=https://kstenerud.github.io/technicalsourcery/tags/headless/ class="badge rounded-pill post-taxonomy">headless</a></span>
</div>
<div class="offcanvas offcanvas-end surface h-100" tabindex=-1 id=offcanvasTOC aria-labelledby=offcanvasTOCLabel>
<div class=offcanvas-header>
<h2 class=offcanvas-title id=offcanvasTOCLabel>Table Of Contents</h5>
<button type=button class="btn btn-sm btn-outline-primary" data-bs-dismiss=offcanvas aria-label=Close>
<i class="fas fa-times"></i>
</button>
</div>
<div class=offcanvas-body>
<nav id=TableOfContents>
<ul>
<li><a href=#prerequisites>Prerequisites</a></li>
<li><a href=#launching-the-vm>Launching the VM</a></li>
<li><a href=#some-tips-before-you-continue>Some tips before you continue</a>
<ul>
<li><a href=#exiting-the-console>Exiting the console</a></li>
<li><a href=#reconnecting-to-the-console>Reconnecting to the console:</a></li>
<li><a href=#deleting-everything-and-starting-over>Deleting everything and starting over</a></li>
<li><a href=#accessing-the-vm-from-your-host>Accessing the VM from your host</a></li>
<li><a href=#getting-the-guests-ip-address>Getting the guest&rsquo;s IP address</a></li>
<li><a href=#connecting-to-the-installer-via-ssh>Connecting to the installer via SSH</a></li>
</ul>
</li>
<li><a href=#installing-nixos>Installing NixOS</a>
<ul>
<li><a href=#switch-to-root>Switch to root</a></li>
<li><a href=#setup-the-disk>Setup the disk</a></li>
<li><a href=#customize-your-install>Customize your install</a></li>
<li><a href=#run-the-installer>Run the installer</a></li>
<li><a href=#reboot>Reboot</a></li>
</ul>
</li>
</ul>
</nav>
</div>
</div><div class="post-content mb-3"><p>NixOS has a lot of really cool ideas, but unfortunately installing on a VM is still tricky. This guide is designed as a &ldquo;just get me something working, please!&rdquo; way to get a headless NixOS install up and running in a libvirt VM.</p>
<h2 id=prerequisites>Prerequisites</h2>
<p>You will need to have libvirt and virt-install on your system.</p>
<p>On Ubuntu:</p>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-text data-lang=text><span class=ln>1</span>sudo apt update
<span class=ln>2</span>sudo apt install qemu-kvm libvirt-daemon-system virtinst
</code></pre></div><p>On Redhat:</p>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-text data-lang=text><span class=ln>1</span>sudo yum install kvm virt-manager libvirt libvirt-python python-virtinst
</code></pre></div><p>You&rsquo;ll also need the <a href=https://nixos.org/download.html target=_blank rel="noopener noreferrer">NixOS minimal ISO image</a>
</p>
<h2 id=launching-the-vm>Launching the VM</h2>
<p>Use the following as an example for launching your vm, picking a decent place to create your qcow2 disk image (you will be installing to this) so that you can find it later:</p>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-text data-lang=text><span class=ln>1</span>virt-install --name=nixos \
<span class=ln>2</span>--memory=8196 \
<span class=ln>3</span>--vcpus=2 \
<span class=ln>4</span>--disk /path/to/my-nixos-disk-image.qcow2,device=disk,bus=virtio,size=16 \
<span class=ln>5</span>--cdrom=/path/to/latest-nixos-minimal-x86_64-linux.iso \
<span class=ln>6</span>--os-type=generic  \
<span class=ln>7</span>--boot=uefi \
<span class=ln>8</span>--nographics \
<span class=ln>9</span>--console pty,target_type=virtio
</code></pre></div><p>This launches a UEFI-enabled (<code>--boot=uefi</code>) headless (<code>--nographics</code>) VM named &ldquo;nixos&rdquo; (<code>--name=nixos</code>) with 8 GB of RAM (<code>--memory=8192</code>), 2 CPUs (<code>--vcpus=2</code>), and a disk image with 16GB of space (<code>size=16</code>). It also connects to the guest&rsquo;s console (<code>--console pty,target_type=virtio</code>).</p>
<p><strong>Note</strong>: The <code>--cdrom</code> entry sets the ISO image to boot from <strong>once</strong>. After rebooting, it will boot from your qcow2 image instead.</p>
<p>After launching the VM, it will sit here for awhile, looking like it&rsquo;s stuck:</p>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-text data-lang=text><span class=ln>1</span>Starting install...
<span class=ln>2</span>Connected to domain nixos
<span class=ln>3</span>Escape character is ^]
</code></pre></div><p>Just be patient; it should boot within a couple of minutes:</p>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-text data-lang=text><span class=ln> 1</span>&lt;&lt;&lt; Welcome to NixOS 21.05.1970.11c662074e2 (x86_64) - hvc0 &gt;&gt;&gt;
<span class=ln> 2</span>The &#34;nixos&#34; and &#34;root&#34; accounts have empty passwords.
<span class=ln> 3</span>
<span class=ln> 4</span>An ssh daemon is running. You then must set a password
<span class=ln> 5</span>for either &#34;root&#34; or &#34;nixos&#34; with `passwd` or add an ssh key
<span class=ln> 6</span>to /home/nixos/.ssh/authorized_keys be able to login.
<span class=ln> 7</span>
<span class=ln> 8</span>
<span class=ln> 9</span>Run &#39;nixos-help&#39; for the NixOS manual.
<span class=ln>10</span>
<span class=ln>11</span>nixos login: nixos (automatic login)
<span class=ln>12</span>
<span class=ln>13</span>
<span class=ln>14</span>[nixos@nixos:~]$
</code></pre></div><h2 id=some-tips-before-you-continue>Some tips before you continue</h2>
<p>There will invariably be problems, so here are some tips to help get you unstuck:</p>
<h3 id=exiting-the-console>Exiting the console</h3>
<p>To exit the console, hold the CTRL key and press <code>]</code>, then press Enter.</p>
<h3 id=reconnecting-to-the-console>Reconnecting to the console:</h3>
<p>To reconnect to the console, type <code>virsh console nixos</code></p>
<h3 id=deleting-everything-and-starting-over>Deleting everything and starting over</h3>
<p>If everything gets completely broken, here&rsquo;s how to start over fresh:</p>
<ul>
<li>Stop the VM by typing <code>virsh destroy nixos</code> (turns off the machine)</li>
<li>Remove the domain by typing <code>virsh undefine nixos --nvram</code> (deletes the VM)</li>
<li>If you want the disk image gone also, you must delete it manually (wherever you put <code>my-nixos-disk-image.qcow2</code>)</li>
</ul>
<h3 id=accessing-the-vm-from-your-host>Accessing the VM from your host</h3>
<p>Use the <code>virsh</code> command to access the VM from the host. It&rsquo;s a good idea to <a href=https://libvirt.org/manpages/virsh.html target=_blank rel="noopener noreferrer">familiarize yourself with virsh</a>
.</p>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-text data-lang=text><span class=ln>1</span>$ virsh list
<span class=ln>2</span> Id   Name    State
<span class=ln>3</span>-----------------------
<span class=ln>4</span> 13   nixos   running
</code></pre></div><h3 id=getting-the-guests-ip-address>Getting the guest&rsquo;s IP address</h3>
<p>You can do this within the guest by typing <code>ip a</code>, or you can do it from the host side using virsh&rsquo;s <code>net-dhcp-leases</code> command:</p>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-text data-lang=text><span class=ln>1</span>$ virsh net-dhcp-leases default
<span class=ln>2</span> Expiry Time           MAC address         Protocol   IP address          Hostname         Client ID or DUID
<span class=ln>3</span>-----------------------------------------------------------------------------------------------------------------
<span class=ln>4</span> 2021-07-23 21:04:31   52:54:00:33:0c:ee   ipv4       192.168.111.206/24   nixos            01:52:54:00:33:0c:ee
<span class=ln>5</span>
</code></pre></div><h3 id=connecting-to-the-installer-via-ssh>Connecting to the installer via SSH</h3>
<p>The console can be a bit funny at times (especially if you resize your shell window), so it&rsquo;s generally nicer to SSH in. We&rsquo;ll use a password-based SSH login since it&rsquo;s only the installer.</p>
<ol>
<li>Create a password (Note: This is only setting a temporary password for the <strong>installer</strong>, not the OS you are about to install):</li>
</ol>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-text data-lang=text><span class=ln>1</span>[nixos@nixos:~]$ passwd
<span class=ln>2</span>New password: 
<span class=ln>3</span>Retype new password: 
<span class=ln>4</span>passwd: password updated successfully
</code></pre></div><ol start=2>
<li>Get the IP address:</li>
</ol>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-text data-lang=text><span class=ln>1</span>[nixos@nixos:~]$ ip a
<span class=ln>2</span>...
<span class=ln>3</span>2: ens2: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc fq_codel state UP group default qlen 1000
<span class=ln>4</span>...
<span class=ln>5</span>    inet 192.168.111.206/24 brd 192.168.111.255 scope global dynamic noprefixroute ens2
<span class=ln>6</span>...
</code></pre></div><ol start=3>
<li>SSH in to the installer:</li>
</ol>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-text data-lang=text><span class=ln>1</span>$ ssh nixos@192.168.111.206
<span class=ln>2</span>Password: 
<span class=ln>3</span>Last login: Sun Aug  1 05:39:07 2021
<span class=ln>4</span>
<span class=ln>5</span>[nixos@nixos:~]$
</code></pre></div><h2 id=installing-nixos>Installing NixOS</h2>
<h3 id=switch-to-root>Switch to root</h3>
<p>Doing the installation process as root makes it less cumbersome, and it&rsquo;s safe since you can&rsquo;t damage the installer ISO image:</p>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-text data-lang=text><span class=ln>1</span>[nixos@nixos:~]$ sudo su -
<span class=ln>2</span>
<span class=ln>3</span>[root@nixos:~]#
</code></pre></div><h3 id=setup-the-disk>Setup the disk</h3>
<p>This follows the <a href=https://nixos.org/manual/nixos/stable/#sec-installation-partitioning target=_blank rel="noopener noreferrer">example in the NixOS manual</a>
, except that your disk is <code>/dev/vda</code>.</p>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-text data-lang=text><span class=ln> 1</span>parted --script /dev/vda -- mklabel gpt
<span class=ln> 2</span>parted --script /dev/vda -- mkpart primary 512MiB -8GiB
<span class=ln> 3</span>parted --script /dev/vda -- mkpart primary linux-swap -8GiB 100%
<span class=ln> 4</span>parted --script /dev/vda -- mkpart ESP fat32 1MiB 512MiB
<span class=ln> 5</span>parted --script /dev/vda -- set 3 esp on
<span class=ln> 6</span>mkfs.ext4 -F -L nixos /dev/vda1
<span class=ln> 7</span>mkswap -L swap /dev/vda2
<span class=ln> 8</span>mkfs.fat -F 32 -n boot /dev/vda3
<span class=ln> 9</span>mount /dev/disk/by-label/nixos /mnt
<span class=ln>10</span>mkdir -p /mnt/boot
<span class=ln>11</span>mount /dev/disk/by-label/boot /mnt/boot
<span class=ln>12</span>swapon /dev/vda2
<span class=ln>13</span>nixos-generate-config --root /mnt
</code></pre></div><h3 id=customize-your-install>Customize your install</h3>
<p>At this point, you can customize your configuration before installing. Configuration happens via <code>configuration.nix</code>, and the default config comes with a number of commented-out suggestions. Normally, you&rsquo;d keep your configuration files in a repository and copy them in to the machine being provisioned.</p>
<p>To edit your configuration:</p>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-text data-lang=text><span class=ln>1</span>[root@nixos:~]# nano /mnt/etc/nixos/configuration.nix
</code></pre></div><p>Once you&rsquo;re happy with your configuration, press CTRL-X and save the file to exit the editor.</p>
<h4 id=configuration-add-an-admin-user>Configuration: Add an admin user</h4>
<p>It&rsquo;s a good idea to create an admin user for yourself because logging in as root is dangerous. Here&rsquo;s an example user with admin privileges:</p>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-text data-lang=text><span class=ln> 1</span>  users.users.myuser = {
<span class=ln> 2</span>    isNormalUser = true;
<span class=ln> 3</span>    home = &#34;/home/myuser&#34;;
<span class=ln> 4</span>    description = &#34;My example admin user&#34;;
<span class=ln> 5</span>    # wheel allows sudo, networkmanager allows network modifications
<span class=ln> 6</span>    extraGroups = [ &#34;wheel&#34; &#34;networkmanager&#34; ];
<span class=ln> 7</span>    # For password login (works with console and SSH):
<span class=ln> 8</span>    hashedPassword = &#34;$6$Cc5l1Gyv2gP$Mw0RKFkH719QCZAggQDTJIDcE4HoHFEYUqS71H0FVA/AHR4BJEWhfyPaR3RKiz3WsMsDp1di4oPX3b1s3s6Jt.&#34;;
<span class=ln> 9</span>    # For SSH key login (works with SSH only):
<span class=ln>10</span>    openssh.authorizedKeys.keys = [ &#34;ssh-dss AAAAB3Nza... myuser@foobar&#34; ];
<span class=ln>11</span>  };
</code></pre></div><p><code>hashedPassword</code> can be generated using <code>mkpasswd</code>:</p>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-text data-lang=text><span class=ln>1</span>[root@nixos:~]# mkpasswd -m sha-512
<span class=ln>2</span>Password: 
<span class=ln>3</span>$6$Cc5l1Gyv2gP$Mw0RKFkH719QCZAggQDTJIDcE4HoHFEYUqS71H0FVA/AHR4BJEWhfyPaR3RKiz3WsMsDp1di4oPX3b1s3s6Jt.
</code></pre></div><h4 id=configuration-enable-ssh>Configuration: Enable SSH</h4>
<p>You can also turn on SSH so that you can connect via secure shell after rebooting (otherwise only the console will work):</p>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-text data-lang=text><span class=ln>1</span>  services.openssh.enable = true; 
</code></pre></div><h3 id=run-the-installer>Run the installer</h3>
<p>Once you&rsquo;re happy with your configuration, it&rsquo;s time to install the OS:</p>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-text data-lang=text><span class=ln>1</span>[root@nixos:~]# nixos-install
</code></pre></div><p>If you&rsquo;ve made any mistakes, it will print out error messages detailing what you need to fix in your <code>configuration.nix</code>.</p>
<p>The last installer step will ask you to set the root password (you can use <code>nixos-install --no-root-passwd</code> to disable this and leave it blank):</p>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-text data-lang=text><span class=ln>1</span>setting root password...
<span class=ln>2</span>Enter new UNIX password: ***
<span class=ln>3</span>Retype new UNIX password: ***
</code></pre></div><h3 id=reboot>Reboot</h3>
<p>This will cause it to reboot into your newly installed disk:</p>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-text data-lang=text><span class=ln> 1</span>[root@nixos:~]# reboot
<span class=ln> 2</span>
<span class=ln> 3</span>Domain creation completed.
<span class=ln> 4</span>Restarting guest.
<span class=ln> 5</span>Connected to domain nixos
<span class=ln> 6</span>Escape character is ^]
<span class=ln> 7</span>
<span class=ln> 8</span>
<span class=ln> 9</span>&lt;&lt;&lt; Welcome to NixOS 21.05.1970.11c662074e2 (x86_64) - hvc0 &gt;&gt;&gt;
<span class=ln>10</span>
<span class=ln>11</span>Run &#39;nixos-help&#39; for the NixOS manual.
<span class=ln>12</span>
<span class=ln>13</span>nixos login: 
</code></pre></div><p>Log in as the admin user you created (or you can log in via SSH if you enbled it). If you need to make further changes to the configuration, edit <code>/etc/nixos/configuration.nix</code> and then build the new configuration:</p>
<div class=highlight><pre tabindex=0 class=chroma><code class=language-text data-lang=text><span class=ln>1</span>nixos-rebuild switch
</code></pre></div><p>At this point, you have a functional NixOS in a virtual machine. You&rsquo;re at the equivalent of <a href=https://nixos.org/manual/nixos/stable/#sec-changing-config target=_blank rel="noopener noreferrer">chapter 3 in the NixOS manual</a>
, and can now start <a href=https://nixos.org/manual/nixos/stable/index.html#ch-configuration target=_blank rel="noopener noreferrer">configuring your OS</a>
.</p>
<p>Enjoy!</p>
</div><hr><div class="post-navs d-flex mb-3 justify-content-evenly">
<div class="post-nav post-prev"><i class="fas fa-fw fa-chevron-left"></i>
<a href=https://kstenerud.github.io/technicalsourcery/posts/on-endianness/>On Endianness
</a>
</div><div class="post-nav post-next">
<a href=https://kstenerud.github.io/technicalsourcery/about/>About Me
</a>
<i class="fas fa-fw fa-chevron-right"></i>
</div></div><section class=related-posts-wrapper>
<h3>Related Posts</h3>
<ul class=related-posts><li><a href=https://kstenerud.github.io/technicalsourcery/posts/on-endianness/>On Endianness
</a></li><li><a href=https://kstenerud.github.io/technicalsourcery/posts/line-lengths/>Line Lengths
</a></li><li><a href=https://kstenerud.github.io/technicalsourcery/posts/virtual-linux-remote-desktop/>Virtual Linux Remote Desktop
</a></li><li><a href=https://kstenerud.github.io/technicalsourcery/posts/intro-high-availability/>Introduction to High Availability
</a></li><li><a href=https://kstenerud.github.io/technicalsourcery/posts/time-timezones/>Time and Timezones: Getting It Right
</a></li></ul>
</section></div>
</article><div class="card component row post-comments">
<div class=card-body><script src=https://utteranc.es/client.js repo=kstenerud/technicalsourcery issue-term=pathname label=comment theme=github-light crossorigin=anonymous async></script></div>
</div></div>
</div><aside class="col-lg-4 sidebar d-flex">
<div class=container>
<section class="card row text-center profile component">
<div class=card-body>
<div class="col-12 d-flex align-items-center justify-content-center"><img class="profile-avatar rounded-circle" alt="Karl Stenerud" src=https://kstenerud.github.io/technicalsourcery/images/profile.jpg loading=lazy width=460 height=460>
</div>
<div class="col-12 profile-meta"><div class=profile-name>Karl Stenerud</div><div class=profile-bio>Networking, protocols, & nitty gritty details.</div><div class=profile-about><i class="fas fa-fw fa-user"></i><a href=https://kstenerud.github.io/technicalsourcery/about/>About Me</a></div></div>
</div>
</section>
<section class="recent-posts row card component">
<div class=card-body>
<h2 class=card-title>Recent Posts</h2>
<ul class=post-list><li><a href=https://kstenerud.github.io/technicalsourcery/posts/nixos-in-libvirt/>Test-Driving a NixOS VM Using Libvirt
</a></li><li><a href=https://kstenerud.github.io/technicalsourcery/posts/on-endianness/>On Endianness
</a></li><li><a href=https://kstenerud.github.io/technicalsourcery/posts/line-lengths/>Line Lengths
</a></li><li><a href=https://kstenerud.github.io/technicalsourcery/posts/virtual-linux-remote-desktop/>Virtual Linux Remote Desktop
</a></li><li><a href=https://kstenerud.github.io/technicalsourcery/posts/intro-high-availability/>Introduction to High Availability
</a></li></ul>
</div>
</section><section class="taxonomies row card component">
<div class=card-body>
<h2 class=card-title>
<a href=https://kstenerud.github.io/technicalsourcery/categories>Categories</a>
</h2>
<div class=py-2><a href=https://kstenerud.github.io/technicalsourcery/categories/endianness/ class="badge rounded post-taxonomy" title=endianness>
endianness
</a><a href=https://kstenerud.github.io/technicalsourcery/categories/high-availability/ class="badge rounded post-taxonomy" title=high-availability>
high-availability
</a><a href=https://kstenerud.github.io/technicalsourcery/categories/programming/ class="badge rounded post-taxonomy" title=programming>
programming
</a><a href=https://kstenerud.github.io/technicalsourcery/categories/remote-desktop/ class="badge rounded post-taxonomy" title=remote-desktop>
remote-desktop
</a><a href=https://kstenerud.github.io/technicalsourcery/categories/time/ class="badge rounded post-taxonomy" title=time>
time
</a><a href=https://kstenerud.github.io/technicalsourcery/categories/virtualization/ class="badge rounded post-taxonomy" title=virtualization>
virtualization
</a></div>
</div>
</section><section class="taxonomies row card component">
<div class=card-body>
<h2 class=card-title>
<a href=https://kstenerud.github.io/technicalsourcery/tags>Tags</a>
</h2>
<div class=py-2><a href=https://kstenerud.github.io/technicalsourcery/tags/endianness/ class="badge rounded post-taxonomy" title=endianness>
endianness
</a><a href=https://kstenerud.github.io/technicalsourcery/tags/headless/ class="badge rounded post-taxonomy" title=headless>
headless
</a><a href=https://kstenerud.github.io/technicalsourcery/tags/high-availability/ class="badge rounded post-taxonomy" title=high-availability>
high-availability
</a><a href=https://kstenerud.github.io/technicalsourcery/tags/libvirt/ class="badge rounded post-taxonomy" title=libvirt>
libvirt
</a><a href=https://kstenerud.github.io/technicalsourcery/tags/linux/ class="badge rounded post-taxonomy" title=linux>
linux
</a><a href=https://kstenerud.github.io/technicalsourcery/tags/nixos/ class="badge rounded post-taxonomy" title=nixos>
nixos
</a><a href=https://kstenerud.github.io/technicalsourcery/tags/programming/ class="badge rounded post-taxonomy" title=programming>
programming
</a><a href=https://kstenerud.github.io/technicalsourcery/tags/remote-desktop/ class="badge rounded post-taxonomy" title=remote-desktop>
remote-desktop
</a><a href=https://kstenerud.github.io/technicalsourcery/tags/time/ class="badge rounded post-taxonomy" title=time>
time
</a><a href=https://kstenerud.github.io/technicalsourcery/tags/timezone/ class="badge rounded post-taxonomy" title=timezone>
timezone
</a></div>
</div>
</section>
</div>
</aside>
</div>
</main><footer class="footer mt-auto py-3 text-center container"><nav class="social-links nav my-2 justify-content-center"><a class="nav-link social-link" href=mailto:kstenerud@gmail.com title=Email>
<i class="fas fa-fw fa-2x fa-envelope"></i>
</a><a class="nav-link social-link" target=_blank href=https://github.com/kstenerud title=GitHub rel="noopener noreferrer">
<i class="fa-fw fa-2x fab fa-github"></i>
</a><a class="nav-link social-link" target=_blank href=https://linkedin.com/in/kstenerud title=LinkedIn rel="noopener noreferrer">
<i class="fa-fw fa-2x fab fa-linkedin-in"></i>
</a></nav>
<div class="copyright mb-2">
Copyright Â© 2018-2021 Karl Stenerud. All Rights Reserved.
</div>
<div class="powered-by mb-2">
Powered by <a href=https://gohugo.io target=_blank rel="noopener noreferrer">Hugo</a> and the <a href=https://github.com/razonyang/hugo-theme-bootstrap target=_blank rel="noopener noreferrer">Bootstrap</a> theme.
</div><a href=https://www.netlify.com>
<img src=https://www.netlify.com/img/global/badges/netlify-color-accent.svg alt="Deploys by Netlify">
</a>
</footer>
<script src=https://kstenerud.github.io/technicalsourcery/js/bundle.min.c9a2705a4f7960fa93b78fcbd45bced560cf3993d862169dec489d9a4ba3b97e.js integrity="sha256-yaJwWk95YPqTt4/L1FvO1WDPOZPYYhad7EidmkujuX4=" crossorigin=anonymous defer></script><script>'serviceWorker'in navigator&&window.addEventListener('load',()=>{navigator.serviceWorker.register('https://kstenerud.github.io/technicalsourcery/service-worker.js').then(function(a){console.log('Successfully registered service worker',a)}).catch(function(a){console.warn('Error whilst registering service worker',a)})})</script>
</body>
</html>